# Create Playwright Tests from Test Suite

## Purpose
Automatically generate Playwright test automation code by analyzing Azure DevOps test cases in a Test Suite, optionally referencing existing MQA test files for patterns and structure.

## Required Inputs
1. **Test Suite ID** (Azure DevOps Test Suite Work Item ID) - Mandatory

## Optional Inputs
2. **MQA File URL** (Azure DevOps repository file path) - Optional reference for test patterns

## Process

### Step 1: Retrieve Test Suite Information
Use the DevOps MCP tool to get the test suite details:
```javascript
mcp_devops-mcp_getWorkItem({
  id: [Test Suite ID]
})
```

Extract:
- Suite name and description
- Test Plan ID from the work item relations
- Area Path and Iteration Path
- Feature context

### Step 2: Get All Test Cases in Suite
Use the MCP tool to retrieve all test cases associated with the suite:
```javascript
mcp_devops-mcp_getTestCasesInSuite({
  planId: [Test Plan ID],
  suiteId: [Test Suite ID]
})
```

This returns all test case IDs and their configurations in the suite.

### Step 3: Retrieve Individual Test Case Details
For each test case ID found in the suite, use MCP tool to get full details:
```javascript
mcp_devops-mcp_getWorkItem({
  id: [Test Case ID]
})
```

Extract from each test case:
- `System.Title` - Test case title
- `Microsoft.VSTS.TCM.Steps` - Test steps in XML format
- Device/platform information from title (Mobile, Desktop)
- Browser requirements
- Priority and automation status

### Step 4: Analyze MQA File (If Provided)
If MQA file URL is provided, parse it to extract:
- Repository ID from URL
- File path from URL
- Branch name from URL (e.g., `version=GBdevelop` → `develop`)

**Example MQA URL:**
```
https://dev.azure.com/MarsDevTeam/RoyalCaninSitecore/_git/Websites.RoyalCanin.UpgradeAutomationTestsGit?path=/cypress/e2e/B2BEntries.feature&version=GBdevelop
```

Extract:
- `repositoryId`: `Websites.RoyalCanin.UpgradeAutomationTestsGit`
- `path`: `/cypress/e2e/B2BEntries.feature`
- `branch`: `develop`

Use MCP tool to get file content:
```javascript
mcp_devops-mcp_getFileContent({
  repositoryId: "Websites.RoyalCanin.UpgradeAutomationTestsGit",
  path: "/cypress/e2e/B2BEntries.feature",
  branch: "develop"
})
```

Analyze the file for:
- Test structure patterns
- Page object usage
- Selector strategies
- Data-driven test patterns
- Reusable step definitions

### Step 5: Parse Test Steps from XML
For each test case, parse the XML formatted test steps:
```xml
<steps id="0" last="3">
  <step id="1" type="ValidateStep">
    <parameterizedString isformatted="true">
      &lt;SPAN&gt;Action description&lt;/SPAN&gt;
    </parameterizedString>
    <parameterizedString isformatted="true">
      &lt;SPAN&gt;Expected result&lt;/SPAN&gt;
    </parameterizedString>
    <description/>
  </step>
</steps>
```

Extract:
- Action descriptions (first parameterizedString)
- Expected results (second parameterizedString)
- Step sequence
- HTML content decoded (convert `&lt;`, `&gt;`, `&amp;` back)

### Step 6: Map Test Steps to Playwright Actions
Convert manual test steps to Playwright automation code:

**Common Mappings:**
- "Navigate to [URL]" → `await page.goto('[URL]')`
- "Click on [element]" → `await page.click('[selector]')`
- "Tap on [element]" → `await page.click('[selector]')` (mobile)
- "Verify [element] is visible" → `await expect(page.locator('[selector]')).toBeVisible()`
- "Check that [element] contains [text]" → `await expect(page.locator('[selector]')).toContainText('[text]')`
- "Scroll down" → `await page.mouse.wheel(0, 500)`
- "Hover over [element]" → `await page.hover('[selector]')`
- "Enter [text] in [field]" → `await page.fill('[selector]', '[text]')`
- "Select [option] from [dropdown]" → `await page.selectOption('[selector]', '[option]')`

**Assertions from Expected Results:**
- "is displayed" → `toBeVisible()`
- "is not displayed" → `not.toBeVisible()`
- "contains [text]" → `toContainText('[text]')`
- "is enabled" → `toBeEnabled()`
- "is disabled" → `toBeDisabled()`
- "has value [value]" → `toHaveValue('[value]')`

### Step 7: Generate Playwright Test Structure
Create Playwright test files following best practices:

**File Naming:**
- Format: `[feature-name].spec.ts`
- Example: `b2b-entries.spec.ts`
- Kebab-case for file names

**Test Structure:**
```typescript
import { test, expect } from '@playwright/test';

test.describe('[Feature Name] - [Device]', () => {
  test.beforeEach(async ({ page }) => {
    // Setup/navigation common to all tests
  });

  test('[Test Case Title]', async ({ page }) => {
    // Step 1: [Action]
    // [Playwright code]
    
    // Verify: [Expected Result]
    // [Assertion code]
    
    // Step 2: [Action]
    // [Playwright code]
    
    // Verify: [Expected Result]
    // [Assertion code]
  });
});
```

**Device-Specific Tests:**
- Desktop tests: Use default viewport
- Mobile tests: Configure mobile viewport in test or use projects
```typescript
test.use({ 
  viewport: { width: 375, height: 667 },
  isMobile: true 
});
```

### Step 8: Organize Tests by Device/Platform
Group tests based on device indicators in test case titles:
- **Desktop Tests**: Tests with "Desktop" in title or no device specified
- **Mobile Tests**: Tests with "Mobile" in title

Create separate describe blocks or files for each platform:
```typescript
test.describe('B2B Entries - Desktop', () => {
  // Desktop tests
});

test.describe('B2B Entries - Mobile', () => {
  test.use({ 
    viewport: { width: 375, height: 667 },
    isMobile: true 
  });
  // Mobile tests
});
```

### Step 9: Generate Page Objects (Optional)
If multiple tests interact with the same elements, create page objects:

**Page Object Structure:**
```typescript
import { Page, Locator } from '@playwright/test';

export class [FeatureName]Page {
  readonly page: Page;
  readonly [elementName]: Locator;

  constructor(page: Page) {
    this.page = page;
    this.[elementName] = page.locator('[selector]');
  }

  async [actionMethod]() {
    // Implementation
  }
}
```

### Step 10: Add Test Data and Configuration
Include test data based on test case parameters:
- Market/country variations
- Language variations
- User types (B2B, D2C)
- Test environment URLs

**Example:**
```typescript
const testData = {
  markets: ['us', 'fr', 'de', 'it', 'nl', 'se', 'tr', 'uk'],
  baseUrl: 'https://staging.royalcanin.com'
};

testData.markets.forEach(market => {
  test(`Check B2B entries - ${market}`, async ({ page }) => {
    await page.goto(`${testData.baseUrl}/${market}`);
    // Test implementation
  });
});
```

### Step 11: Create Branch and Commit Files
Use MCP tools to create a new branch and commit the generated test files:

**Create Branch:**
```javascript
mcp_devops-mcp_createBranch({
  repositoryId: "[Repository ID]",
  branchName: "test/[feature-name]-playwright-tests",
  sourceBranch: "develop"
})
```

**Prepare File Changes:**
Convert TypeScript code to base64:
```javascript
const content = Buffer.from(playwrightTestCode).toString('base64');
```

**Commit Files:**
```javascript
mcp_devops-mcp_createCommit({
  repositoryId: "[Repository ID]",
  branchName: "test/[feature-name]-playwright-tests",
  commitMessage: "Add Playwright tests for [Feature Name] based on Test Suite [Suite ID]",
  changes: [
    {
      path: "/tests/[feature-name].spec.ts",
      changeType: "add",
      content: "[base64 encoded content]",
      encoding: "base64"
    }
  ]
})
```

### Step 12: Create Pull Request
Use MCP tool to create a pull request:
```javascript
mcp_devops-mcp_createPullRequest({
  repositoryId: "[Repository ID]",
  sourceBranch: "test/[feature-name]-playwright-tests",
  targetBranch: "develop",
  title: "Add Playwright tests for [Feature Name]",
  description: "Auto-generated Playwright tests based on Test Suite [Suite ID]\n\nTest Cases Covered:\n- [List of test case titles]\n\nGenerated from:\n- Test Suite ID: [Suite ID]\n- Test Plan ID: [Plan ID]"
})
```

## Output

Provide a comprehensive summary including:

### 1. Test Suite Analysis
- Suite ID and name
- Total test cases found
- Test case IDs processed
- Device/platform distribution (Desktop/Mobile)
- Priority distribution

### 2. Generated Test Files
- File names and paths
- Number of tests per file
- Test coverage mapping (which test case → which Playwright test)

### 3. Code Generation Summary
- Total lines of code generated
- Number of page objects created (if any)
- Shared utilities created
- Test data files created

### 4. MQA Analysis (If Provided)
- Patterns identified from MQA file
- Reusable components found
- Selector strategies adopted
- Data-driven test patterns applied

### 5. Git Operations
- Branch created: `test/[feature-name]-playwright-tests`
- Commit ID and message
- Files added/modified in commit
- Pull request ID and URL

### 6. Next Steps
- Review pull request
- Run tests locally: `npx playwright test [file-name]`
- Run tests in CI/CD pipeline
- Update test automation status in test cases

## Best Practices

### Code Quality
- Use meaningful test names matching test case titles
- Add comments referencing test case IDs
- Use async/await consistently
- Implement proper error handling
- Add retry logic for flaky selectors

### Selectors Strategy
- Prefer data-testid attributes
- Use aria-labels for accessibility
- Avoid CSS selectors tied to styling
- Use text selectors for stable elements
- Chain locators for specificity

### Test Independence
- Each test should be independent
- Use beforeEach for common setup
- Clean up test data in afterEach
- Don't rely on test execution order

### Assertions
- Use specific assertions (toBeVisible vs toBeTruthy)
- Add custom error messages to assertions
- Verify multiple properties when needed
- Use soft assertions for multiple checks

### Maintainability
- Keep tests DRY with helper functions
- Extract common selectors to constants
- Use page objects for complex pages
- Parameterize tests for data variations

## Example Output Format

```markdown
## Playwright Test Generation Complete

### Test Suite: B2B entries (ID: 957589)
- **Test Plan ID**: 552002
- **Total Test Cases**: 6
- **Test Cases Processed**: 957596, 957597, 1240969, 1240968, 1240966, 1240967
- **Device Distribution**: 3 Desktop, 3 Mobile
- **Priority**: All Priority 2

### Generated Files
1. **tests/b2b-entries.spec.ts** (345 lines)
   - 6 test cases
   - 2 describe blocks (Desktop, Mobile)
   - Test case mapping:
     - 957596 → "Check B2B entries - Desktop"
     - 957597 → "Check B2B entries - Mobile"
     - 1240969 → "Check B2B entries dropdown styling - Desktop"
     - 1240968 → "Check B2B entries visibility on pages - Desktop"
     - 1240966 → "Check B2B entries across markets - Mobile"
     - 1240967 → "Check B2B entries across markets - Desktop"

2. **tests/fixtures/test-data.ts** (45 lines)
   - Markets configuration
   - Base URLs
   - User types

### MQA Reference Analysis
- **File**: /cypress/e2e/B2BEntries.feature
- **Patterns Adopted**: 
  - Gherkin-style step organization
  - Market parameterization
  - Dropdown interaction patterns
- **Selectors Identified**: 
  - B2B dropdown: `[data-testid="b2b-dropdown"]`
  - Country selector: `[aria-label="Country selector"]`

### Git Operations
- **Branch Created**: `test/b2b-entries-playwright-tests`
- **Commit**: `abc123def - Add Playwright tests for B2B Entries based on Test Suite 957589`
- **Files Added**: 
  - /tests/b2b-entries.spec.ts
  - /tests/fixtures/test-data.ts
- **Pull Request**: #456 - https://dev.azure.com/.../pullrequest/456

### Next Steps
1. Review PR: https://dev.azure.com/.../pullrequest/456
2. Run tests locally: `npx playwright test b2b-entries.spec.ts`
3. Update test case automation status to "Automated"
4. Configure CI/CD pipeline to run tests
```

## Integration with Other Prompts
This prompt works with:
- **1.StudyTestCasesInSuite.md** - Understand test patterns before generation
- **2.CreateTestCaseInSuite.md** - Create manual test cases first, then automate them

## Error Handling
- If Test Suite ID is invalid or not found, report error and exit
- If test cases have incomplete steps, generate skeleton tests with TODO comments
- If MQA file URL is invalid, continue without MQA reference
- If repository operations fail, report what was generated locally
- If selectors cannot be determined, add comments for manual review

## Notes
- All Playwright tests should use the staging domain: `https://staging.royalcanin.com`
- Generate tests in TypeScript for type safety
- Follow Playwright best practices and naming conventions
- Include test case IDs in comments for traceability
- Consider creating a config file for environment-specific URLs
